# Upgrade BridgeL2SovereignChain

Script to create schedule and execute transaction for upgrading BridgeL2SovereignChain to version 10.1.1

## Setup

- install packages

```
npm i
```

- Set env variables

```
cp .env.example .env
```

Fill `.env` with your `ETHERSCAN_API_KEY` and `DEPLOYER_PRIVATE_KEY`

- Copy configuration files:

```
cp ./upgrade/upgradeSbridge1011/upgrade_parameters.json.example ./upgrade/upgradeSbridge1011/upgrade_parameters.json
```

- Fill configuration file:
    - "tagSCPreviousVersion": -> tasg of the previous version
    - "bridgeL2SovereignChainAddress": -> The address of the sovereign bridge contract to upgrade.
    - "timelockDelay": 3600, -> the timelock delay between schedule and execution transaction
    - "forkParams": -> Optional: Parameters needed to do shallow fork test
      - "rpc url": "https..." -> Optional: rpc of the node to fork

- Run tool:

```
npx hardhat run ./upgrade/upgradeSbridge1011/upgradeSbridge1011.ts --network custom
```

- OutputFile: `upgrade_output.json`

```
{
 "tagSCPreviousVersion": "v1.0.0",
 "gitInfo": {
  "commit": "3cee977c7434d20627717d302f9e45055439437b",
  "repo": "git@github.com:agglayer/agglayer-contracts.git"
 },
 "inputs": {
  "bridgeL2SovereignChainAddress": "0x1348947e282138d8f377b467F7D9c2EB0F335d1f",
  "timelockDelay": 3600,
  "salt": "0x0000000000000000000000000000000000000000000000000000000000000000"
 },
 "timelockContractAddress": "0xb8fBBbefc6fB8CA6b97644781ebD3432020118ac",
 "bridgeImplementationAddress": "0x39cB637F04e29EF185013A74868f7b22eB5bA173",
 "scheduleData": "0x01d5062a000000000000000000000000e9e0baae3eeb4f0d1a2e8cd36ceb61ab8ad83f95000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e10000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000001348947e282138d8f377b467f7d9c2eb0f335d1f00000000000000000000000039cb637f04e29ef185013a74868f7b22eb5ba17300000000000000000000000000000000000000000000000000000000",
 "executeData": "0x134008d3000000000000000000000000e9e0baae3eeb4f0d1a2e8cd36ceb61ab8ad83f95000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000001348947e282138d8f377b467f7d9c2eb0f335d1f00000000000000000000000039cb637f04e29ef185013a74868f7b22eb5ba17300000000000000000000000000000000000000000000000000000000",
 "implementationDeployBlockNumber": 2621864,
 "deployedContracts": {
  "bridgeImplementation": "0x39cB637F04e29EF185013A74868f7b22eB5bA173",
  "wrappedTokenBytecodeStorer": "0x49cBD4FB52230dBB1324190E8ef76705aE418056",
  "wrappedTokenBridgeImplementation": "0xE2149493bBc17B70B4E79D0596416E079Ad234FA"
 },
 "decodedScheduleData": {
  "target": "0xe9E0BAAe3eEB4F0D1A2e8cd36CEB61Ab8ad83f95",
  "value": 0,
  "data": "0x99a88ec40000000000000000000000001348947e282138d8f377b467f7d9c2eb0f335d1f00000000000000000000000039cb637f04e29ef185013a74868f7b22eb5ba173",
  "decodedData": {
   "signature": "upgrade(address,address)",
   "selector": "0x99a88ec4",
   "proxy": "0x1348947e282138d8f377b467F7D9c2EB0F335d1f",
   "implementation": "0x39cB637F04e29EF185013A74868f7b22eB5bA173"
  },
  "predecessor": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "salt": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "delay": 3600
 }
}
```

This JSON file contains the parameters generated by our upgrade script. Below is a breakdown of each field:

- **scheduleData**:
  The ABI-encoded data that represents the timelock scheduling call. It contains all parameters (target, value, data, predecessor, salt, delay) that the timelock contract will store when the upgrade operation is scheduled.

- **executeData**:
  The ABI-encoded data for the timelock execution call. This is used later to execute the scheduled operation, triggering the proxy upgrade and any initialization.

- **timelockContractAddress**:
  The address of the Timelock contract that will manage the delay and execution of the upgrade operation.

- **implementationDeployBlockNumber**:
  The block number where the implementation contract was deployed. It is used for testing purposes on the shallow fork test

- **decodedScheduleData**:
  A human-readable object that decodes the contents of the scheduled operation:

    - **target**:
      The contract address that will be called by the timelock (typically the ProxyAdmin contract).
    - **value**:
      The ETH value to send with the call (usually 0).
    - **data**:
      The raw encoded data representing the upgrade call (e.g., `upgradeAndCall` with proxy, new implementation, and initialization data).
    - **decodedData**:
      A further breakdown of the `data` field:
        - **signature**: The function signature being called (e.g., `"upgradeAndCall(address,address,bytes)"`).
        - **selector**: The first 4 bytes of the ABI-encoded function call.
        - **proxy**: The proxy contract address that will be upgraded.
        - **implementation**: The address of the new implementation contract.
        - **data**: The ABI-encoded initialization call for the new implementation.
    - **predecessor**:
      The hash of a prior operation that must complete before this one; if none exists, this is zero.
    - **salt**:
      A unique salt used to identify and secure the operation.
    - **delay**:
      The timelock delay (in seconds) required before the scheduled operation can be executed (e.g., "3600" means a one-hour delay).

This structure allows us to verify and audit every aspect of the upgrade operation before it is executed.
